# ======================================================================
# ðŸ‡¾ðŸ‡ª YemenJPT Enterprise - Master Docker Compose File (V4.101)
# ======================================================================
version: '3.8'

networks:
  raidan_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

services:

  # --- 1. CORE INFRASTRUCTURE ---
  nginx-proxy-manager:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: nginx-proxy-manager
    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
      - '8181:81' # Admin UI
    volumes:
      - ./data/npm/data:/data
      - ./data/npm/letsencrypt:/etc/letsencrypt
    networks:
      - raidan_net

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./data/portainer:/data
    networks:
      - raidan_net
  
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: --cleanup --schedule "0 0 4 * * *" # Run at 4 AM daily
    networks:
      - raidan_net

  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare-tunnel
    restart: unless-stopped
    command: tunnel --no-autoupdate run
    environment:
      - TUNNEL_TOKEN=${CF_API_TOKEN}
    networks:
      - raidan_net
    depends_on:
      - nginx-proxy-manager

  # --- 2. DATABASES & STORAGE ---
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    networks:
      raidan_net:
        ipv4_address: 172.25.0.5

  mariadb:
    image: mariadb:latest
    container_name: mariadb
    restart: unless-stopped
    volumes:
      - ./data/mariadb:/var/lib/mysql
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_DATABASE=${MARIADB_DATABASE}
      - MARIADB_USER=${MARIADB_USER}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD}
    networks:
      raidan_net:
        ipv4_address: 172.25.0.6

  redis:
    image: redis:alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    networks:
      raidan_net:
        ipv4_address: 172.25.0.7

  minio:
    image: minio/minio:latest
    container_name: minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - ./data/minio:/data
    networks:
      raidan_net:
        ipv4_address: 172.25.0.8

  # --- 3. THE BRAIN (AI STACK) ---
  ollama:
    image: ollama/ollama
    container_name: ollama
    restart: unless-stopped
    volumes:
      - ./data/ollama:/root/.ollama
    environment:
      - OLLAMA_KEEP_ALIVE=${OLLAMA_KEEP_ALIVE}
    networks:
      raidan_net:
        ipv4_address: 172.25.0.20
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  label-studio:
    image: heartexlabs/label-studio:latest
    container_name: label-studio
    restart: unless-stopped
    environment:
      - LABEL_STUDIO_HOST=https://label-studio.${DOMAIN}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
    depends_on:
      - postgres
    volumes:
      - ./data/label-studio:/label-studio/data
    networks:
      - raidan_net

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    restart: unless-stopped
    volumes:
      - ./data/n8n:/home/node/.n8n
    networks:
      - raidan_net
    depends_on:
      - redis

  # --- 4. MEDIA EMPIRE ---
  ghost:
    image: ghost:latest
    container_name: ghost
    restart: unless-stopped
    volumes:
      - ./data/ghost:/var/lib/ghost/content
    environment:
      - database__client=mysql
      - database__connection__host=${GHOST_DB_HOST}
      - database__connection__user=${GHOST_DB_USER}
      - database__connection__password=${GHOST_DB_PASSWORD}
      - database__connection__database=${GHOST_DB_NAME}
      - url=${GHOST_URL}
    networks:
      - raidan_net
    depends_on:
      - mariadb

  wordpress:
    image: wordpress:latest
    container_name: wordpress
    restart: unless-stopped
    volumes:
      - ./data/wordpress:/var/www/html
    environment:
      - WORDPRESS_DB_HOST=${WORDPRESS_DB_HOST}
      - WORDPRESS_DB_USER=${WORDPRESS_DB_USER}
      - WORDPRESS_DB_PASSWORD=${WORDPRESS_DB_PASSWORD}
      - WORDPRESS_DB_NAME=${WORDPRESS_DB_NAME}
    networks:
      - raidan_net
    depends_on:
      - mariadb

  azuracast_web:
    image: azuracast/azuracast:latest
    container_name: azuracast_web
    restart: unless-stopped
    command: 'azuracast_web'
    volumes:
      - ./data/azuracast/stations:/var/azuracast/stations
    depends_on:
      - mariadb
      - redis
    networks:
      - raidan_net
      
  azuracast_station:
    image: azuracast/azuracast:latest
    container_name: azuracast_station
    restart: unless-stopped
    command: 'azuracast_station'
    volumes:
      - ./data/azuracast/stations:/var/azuracast/stations
    depends_on:
      - azuracast_web
    networks:
      - raidan_net

  restreamer:
    image: datarhei/restreamer:latest
    container_name: restreamer
    restart: unless-stopped
    volumes:
      - ./data/restreamer/config:/core/config
      - ./data/restreamer/data:/core/data
    networks:
      - raidan_net

  # --- 5. SECURITY & OPS ---
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    volumes:
      - ./data/vaultwarden:/data
    networks:
      - raidan_net

  languagetool:
    image: erikvl87/languagetool
    container_name: languagetool
    restart: unless-stopped
    environment:
      - langTool_userSettings=/config/user.conf
    volumes:
      - ./data/languagetool:/config
    networks:
      - raidan_net

  gitea:
    image: gitea/gitea:latest
    container_name: gitea
    restart: unless-stopped
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=postgres
      - GITEA__database__HOST=${GITEA_DB_HOST}
      - GITEA__database__NAME=${GITEA_DB_NAME}
      - GITEA__database__USER=${GITEA_DB_USER}
      - GITEA__database__PASSWD=${GITEA_DB_PASSWD}
    volumes:
      - ./data/gitea:/data
    depends_on:
      - postgres
    networks:
      raidan_net:
        ipv4_address: 172.25.0.10

  # --- 6. YEMENJPT UNIFIED CONTROLLER ---
  yemenjpt_frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: yemenjpt_frontend
    restart: unless-stopped
    networks:
      raidan_net:
        ipv4_address: 172.25.0.51

  yemenjpt_backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: yemenjpt_backend
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_ROOT_CHAT_ID=${TELEGRAM_ROOT_CHAT_ID}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./scripts:/opt/scripts # For panic button
    networks:
      raidan_net:
        ipv4_address: 172.25.0.50
